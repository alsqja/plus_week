# Actions 이름 github 페이지에서 볼 수 있다.
name: Run Test

# Event Trigger 특정 액션 (Push, Pull_Request)등이 명시한 Branch에서 일어나면 동작을 수행한다.
on: 
    push:
        # 배열로 여러 브랜치를 넣을 수 있다.
        branches: [ develop, feature/* ]
    # github pull request 생성시
    pull_request:
        branches: 
            - develop # -로 여러 브랜치를 명시하는 것도 가능

    # 실제 어떤 작업을 실행할지에 대한 명시
jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
    # 1. 저장소 체크아웃
    - name: Check out code
      uses: actions/checkout@v3

    # 2. JDK 설정
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin' # OpenJDK 배포판
        java-version: '17'

    # 3. 의존성 설치 및 테스트 실행
    - name: Run Gradle Tests
      run: |
        ./gradlew clean test
      continue-on-error: true # 테스트 실패 시 워크플로우 계속 실행

    # 4. 커밋 작성자 이메일 추출
    - name: Extract Commit Author Email
      id: extract-email
      run: |
        COMMIT_EMAIL=$(git log -1 --pretty=format:'%ae')
        echo "commit_email=$COMMIT_EMAIL" >> $GITHUB_ENV

    # 5. 테스트 실패 시 이메일 전송
    - name: Send email to pusher
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com # SMTP 서버 주소
        server_port: 587
        username: ${{ secrets.SMTP_USERNAME }} # GitHub Secrets에서 설정한 SMTP 사용자명
        password: ${{ secrets.SMTP_PASSWORD }} # GitHub Secrets에서 설정한 SMTP 비밀번호
        subject: "🚨 Test Failure Alert for ${{ github.repository }} [${{ github.ref }}]"
        body: |
          Hello,

          The tests have failed for commit ${{ github.sha }} on branch ${{ github.ref_name }}.
          Please check the details at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Regards,
          GitHub Actions
        to: ${{ env.commit_email }} # 커밋한 사람의 이메일
        from: test@test.com

