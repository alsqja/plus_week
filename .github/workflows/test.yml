# Actions ì´ë¦„ github í˜ì´ì§€ì—ì„œ ë³¼ ìˆ˜ ìˆë‹¤.
name: Run Test

# Event Trigger íŠ¹ì • ì•¡ì…˜ (Push, Pull_Request)ë“±ì´ ëª…ì‹œí•œ Branchì—ì„œ ì¼ì–´ë‚˜ë©´ ë™ì‘ì„ ìˆ˜í–‰í•œë‹¤.
on: 
    push:
        # ë°°ì—´ë¡œ ì—¬ëŸ¬ ë¸Œëœì¹˜ë¥¼ ë„£ì„ ìˆ˜ ìˆë‹¤.
        branches: [ develop, feature/* ]
    # github pull request ìƒì„±ì‹œ
    pull_request:
        branches: 
            - develop # -ë¡œ ì—¬ëŸ¬ ë¸Œëœì¹˜ë¥¼ ëª…ì‹œí•˜ëŠ” ê²ƒë„ ê°€ëŠ¥

    # ì‹¤ì œ ì–´ë–¤ ì‘ì—…ì„ ì‹¤í–‰í• ì§€ì— ëŒ€í•œ ëª…ì‹œ
jobs:
  run-tests:
    runs-on: ubuntu-latest

    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - name: Check out code
      uses: actions/checkout@v3

    # 2. JDK ì„¤ì •
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin' # OpenJDK ë°°í¬íŒ
        java-version: '17'

    # 3. ì˜ì¡´ì„± ì„¤ì¹˜ ë° í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    - name: Run Gradle Tests
      run: |
        ./gradlew clean test
      continue-on-error: true # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì›Œí¬í”Œë¡œìš° ê³„ì† ì‹¤í–‰

    # 4. ì»¤ë°‹ ì‘ì„±ì ì´ë©”ì¼ ì¶”ì¶œ
    - name: Extract Commit Author Email
      id: extract-email
      run: |
        COMMIT_EMAIL=$(git log -1 --pretty=format:'%ae')
        echo "commit_email=$COMMIT_EMAIL" >> $GITHUB_ENV

    # 5. í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì´ë©”ì¼ ì „ì†¡
    - name: Send email to pusher
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com # SMTP ì„œë²„ ì£¼ì†Œ
        server_port: 587
        username: ${{ secrets.SMTP_USERNAME }} # GitHub Secretsì—ì„œ ì„¤ì •í•œ SMTP ì‚¬ìš©ìëª…
        password: ${{ secrets.SMTP_PASSWORD }} # GitHub Secretsì—ì„œ ì„¤ì •í•œ SMTP ë¹„ë°€ë²ˆí˜¸
        subject: "ğŸš¨ Test Failure Alert for ${{ github.repository }} [${{ github.ref }}]"
        body: |
          Hello,

          The tests have failed for commit ${{ github.sha }} on branch ${{ github.ref_name }}.
          Please check the details at: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          Regards,
          GitHub Actions
        to: ${{ env.commit_email }} # ì»¤ë°‹í•œ ì‚¬ëŒì˜ ì´ë©”ì¼
        from: test@test.com

